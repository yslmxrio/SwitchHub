{
  "name": "Cisco Catalyst 3850 (IOS-XE) Recovery (MODE)",
  "description": "Destructive reset. Requires physical MODE button press. Bypasses config, wipes nvram, and cleans inactive images.",
  "steps": [
    {
      "name": "Waiting for MODE button",
      "status": "Waiting for user (Press MODE button)",
      "require_physical_interact": true,
      "command": null,
      "expect": "switch:",
      "timeout": 180
    },
    {
      "name": "Initializing flash_init",
      "status": "Initializing flash_init",
      "command": "flash_init",
      "expect": "....done Initializing Flash.",
      "timeout": 30
    },
    {
      "name":"Edit switch registry cfg",
      "status": "Editing switch CFG",
      "command": "SWITCH_IGNORE_STARTUP_CFG=1",
      "expect": "switch:",
      "timeout": 30
    },
    {
      "name": "Booting",
      "status": "Booting into bypass mode",
      "command": "boot",
      "expect": "Press RETURN to get started!",
      "timeout": 600
    },
    {
      "name": "Pressing RETURN",
      "status": "Pressing RETURN",
      "command": "",
      "expect": "Switch>",
      "timeout": 40
    },
    {
      "name": "Entering Privileged Mode",
      "status": "Entering Privileged Mode",
      "command": "enable",
      "expect": "Switch#",
      "timeout": 10
    },
    {
      "name": "Erasing startup-config (nvram)",
      "status": "Erasing startup-config",
      "command": "write erase",
      "expect": "Erasing the nvram filesystem will remove all configuration files!.*confirm",
      "timeout": 25
    },
    {
      "name": "Confirming erase",
      "status": "Erasing config",
      "command": "",
      "expect": "Erase of nvram: complete",
      "timeout": 45
    },
    {
      "name": "Deleting vlan.dat",
      "status": "Deleting vlan.dat",
      "command": "delete flash:vlan.dat",
      "expect": "Delete filename.*",
      "timeout": 20
    },
    {
      "name": "Confirm file delete",
      "status": "Deleting vlan.dat",
      "command": "",
      "expect": "Delete.*[confirm]",
      "timeout": 20
    },
    {
      "name": "Confirm vlan.dat delete",
      "status": "Deleting vlan.dat",
      "command": "",
      "expect": "Switch#",
      "timeout": 20
    },
    {
      "name": "Entering Privileged Mode",
      "status": "Finalizing setup",
      "command": "enable",
      "expect": "Switch#",
      "timeout": 10
    },
    {
      "name": "Entering Tcl shell",
      "status": "Cleaning flash (Tcl)",
      "command": "tclsh",
      "expect": "Switch\\(tcl\\)#",
      "timeout": 10
    },
    {
      "name": "Tcl: Starting loop",
      "status": "Cleaning flash (Tcl)",
      "command": "foreach f [glob flash:/*] { \\",
      "expect": "\\+>",
      "timeout": 10
    },
    {
      "name": "Tcl: Setting vars",
      "status": "Cleaning flash (Tcl)",
      "command": "set fname [file tail $f]; set ext [file extension $f]; \\",
      "expect": "\\+>",
      "timeout": 10
    },
    {
      "name": "Tcl: If block",
      "status": "Cleaning flash (Tcl)",
      "command": "if {[string match \"c*universal*\" $fname] || [string match \"cat*universal*\" $fname] || [string match \".E*\" $ext] || [string match \"cat\" $fname] || [string match \".pkg\" $ext] || ([string match \"package*\" $fname] && [string match \".conf\" $ext])} { \\",
      "expect": "\\+>",
      "timeout": 10
    },
    {
      "name": "Tcl: Skip logic",
      "status": "Cleaning flash (Tcl)",
      "command": "puts \"Skipping possible IOS image: $fname\"; continue }; \\",
      "expect": "\\+>",
      "timeout": 10
    },
    {
      "name": "Tcl: Delete logic",
      "status": "Cleaning flash (Tcl)",
      "command": "puts \"Deleting file/dir: $fname\"; exec delete /force /recursive $f }",
      "expect": "Switch\\(tcl\\)#",
      "timeout": 120
    },
    {
      "name": "Exiting Tcl shell",
      "status": "Finalizing cleanup",
      "command": "tclquit",
      "expect": "Switch#",
      "timeout": 10
    },
    {
      "name": "Workflow Complete",
      "status": "Successfully Finished",
      "command": null,
      "expect": null,
      "timeout": 0,
      "complete": true
    }
  ]
}